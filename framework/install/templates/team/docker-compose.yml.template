# MachinEdge Expert Teams — Docker Compose
# Generated by install-team.sh — re-run to regenerate.
#
# Usage:
#   docker compose up -d          # Start the team
#   docker compose logs -f        # Watch all logs
#   docker compose down           # Stop the team
#   docker compose down -v        # Stop and remove all data

services:

  # ─────────────────────────────────────────────
  # Matrix Homeserver (Conduit)
  # Lightweight Rust-based homeserver for inter-expert communication
  # ─────────────────────────────────────────────
  conduit:
    image: matrixconduit/matrix-conduit:latest
    container_name: ${COMPOSE_PROJECT_NAME}-conduit
    volumes:
      - conduit-data:/var/lib/matrix-conduit
      - ./configs/conduit/conduit.toml:/etc/conduit/conduit.toml:ro
    environment:
      - CONDUIT_CONFIG=/etc/conduit/conduit.toml
    ports:
      - "${CONDUIT_PORT:-6167}:6167"
    networks:
      - octeam
    restart: unless-stopped

  # ─────────────────────────────────────────────
  # Element Web (Human Interface)
  # Browser-based Matrix client for interacting with the team
  # Open http://localhost:${ELEMENT_PORT} in your browser
  # ─────────────────────────────────────────────
  element-web:
    image: vectorim/element-web:latest
    container_name: ${COMPOSE_PROJECT_NAME}-element
    volumes:
      - ./configs/element/config.json:/app/config.json:ro
    ports:
      - "${ELEMENT_PORT:-8009}:80"
    networks:
      - octeam
    depends_on:
      conduit:
        condition: service_started
    restart: unless-stopped

  # ─────────────────────────────────────────────
  # OpenClaw Gateway
  # Agent routing, tool execution, and multi-agent coordination
  # ─────────────────────────────────────────────
  openclaw-gateway:
    image: ${OPENCLAW_IMAGE:-alpine/openclaw}
    container_name: ${COMPOSE_PROJECT_NAME}-gateway
    user: "0:0"
    ports:
      - "${OPENCLAW_PORT:-18789}:18789"
    volumes:
      - openclaw-config:/home/node/.openclaw
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    networks:
      - octeam
    depends_on:
      conduit:
        condition: service_started
    restart: unless-stopped

  # ─────────────────────────────────────────────
  # Matrix Setup (one-shot)
  # Registers users and creates rooms, then exits
  # Re-run: docker compose run --rm matrix-setup
  # ─────────────────────────────────────────────
  matrix-setup:
    image: curlimages/curl:latest
    container_name: ${COMPOSE_PROJECT_NAME}-matrix-setup
    entrypoint: ["/bin/sh", "/scripts/setup-matrix.sh"]
    command: []
    volumes:
      - ./scripts:/scripts:ro
    environment:
      - CONDUIT_URL=http://conduit:6167
      - MATRIX_SERVER_NAME=${MATRIX_SERVER_NAME}
      - MATRIX_ADMIN_PASSWORD=${MATRIX_ADMIN_PASSWORD:-admin-changeme}
      - EXPERT_LIST={{EXPERT_LIST_CSV}}
      - ELEMENT_PORT=${ELEMENT_PORT:-8009}
    networks:
      - octeam
    depends_on:
      conduit:
        condition: service_started
    restart: "no"

  # ─────────────────────────────────────────────
  # Expert Containers
  # One container per expert, each with its own workspace clone
  # ─────────────────────────────────────────────

{{EXPERT_SERVICES}}

networks:
  octeam:
    name: ${COMPOSE_PROJECT_NAME}-network

volumes:
  conduit-data:
  openclaw-config:
{{EXPERT_VOLUMES}}