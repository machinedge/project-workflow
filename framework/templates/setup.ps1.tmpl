# {{WORKFLOW_DISPLAY_NAME}} Toolkit — Setup (Windows)
# Usage: .\setup.ps1 [-Editor claude|cursor|both] [-Target <project-directory>]
#
# Copies editor config and commands into a project directory.
# Commands are maintained once in this toolkit and copied to the
# right location for each editor.
#
# Examples:
#   .\setup.ps1                                  # Both editors, current directory
#   .\setup.ps1 -Editor cursor -Target ~\myproj  # Cursor only
#   .\setup.ps1 -Editor claude -Target ~\myproj  # Claude Code only
#   .\setup.ps1 -Target ~\myproj                 # Both editors (default)

param(
    [ValidateSet("claude", "cursor", "both")]
    [string]$Editor = "both",

    [string]$Target = "."
)

$ErrorActionPreference = "Stop"

# Resolve the directory where this script lives (the toolkit root)
$ScriptDir = $PSScriptRoot

if ($Target -ne ".") {
    New-Item -ItemType Directory -Path $Target -Force | Out-Null
}

Write-Host "Setting up {{WORKFLOW_NAME}} toolkit in: $Target (editor: $Editor)"

# ─────────────────────────────────────────────
# Shared docs directory
# ─────────────────────────────────────────────

New-Item -ItemType Directory -Path "$Target/docs/handoff-notes" -Force | Out-Null

# GUIDE: Add domain-specific directories here. Examples:
# New-Item -ItemType Directory -Path "$Target/notebooks" -Force | Out-Null
# New-Item -ItemType Directory -Path "$Target/data/raw" -Force | Out-Null

if (-not (Test-Path "$Target/docs/lessons-log.md")) {
    @"
# Lessons Log

Record project-specific gotchas, patterns, and knowledge here. Future sessions will read this to avoid repeating mistakes.

| Date | Lesson | Context |
|------|--------|---------|
"@ | Set-Content -Path "$Target/docs/lessons-log.md" -Encoding UTF8
}

# ─────────────────────────────────────────────
# Claude Code setup
# editor.md is copied as-is to .claude/CLAUDE.md
# ─────────────────────────────────────────────

if ($Editor -eq "claude" -or $Editor -eq "both") {
    Write-Host "  Setting up Claude Code (.claude/)..."
    New-Item -ItemType Directory -Path "$Target/.claude/commands" -Force | Out-Null
    Copy-Item "$ScriptDir/editor.md" -Destination "$Target/.claude/CLAUDE.md" -Force
    Copy-Item "$ScriptDir/commands/*.md" -Destination "$Target/.claude/commands/" -Force
}

# ─────────────────────────────────────────────
# Cursor setup
# editor.md + YAML frontmatter → .cursor/rules/{{CURSOR_RULES_FILE}}
# ─────────────────────────────────────────────

if ($Editor -eq "cursor" -or $Editor -eq "both") {
    Write-Host "  Setting up Cursor (.cursor/)..."
    New-Item -ItemType Directory -Path "$Target/.cursor/rules" -Force | Out-Null
    New-Item -ItemType Directory -Path "$Target/.cursor/commands" -Force | Out-Null

    # Prepend Cursor's frontmatter to the shared editor rules
    $frontmatter = @"
---
description: {{WORKFLOW_DISPLAY_NAME}} — multi-session {{WORKFLOW_NAME}} protocol
alwaysApply: true
---

"@
    $editorContent = Get-Content "$ScriptDir/editor.md" -Raw
    ($frontmatter + $editorContent) | Set-Content -Path "$Target/.cursor/rules/{{CURSOR_RULES_FILE}}" -Encoding UTF8

    Copy-Item "$ScriptDir/commands/*.md" -Destination "$Target/.cursor/commands/" -Force
}

# ─────────────────────────────────────────────
# Summary
# ─────────────────────────────────────────────

Write-Host ""
Write-Host "Done! Project structure created:"
Write-Host ""

Get-ChildItem "$Target/docs" -Recurse -File | Sort-Object FullName | ForEach-Object {
    Write-Host "  $($_.FullName)"
}
if ($Editor -eq "claude" -or $Editor -eq "both") {
    Get-ChildItem "$Target/.claude" -Recurse -File | Sort-Object FullName | ForEach-Object {
        Write-Host "  $($_.FullName)"
    }
}
if ($Editor -eq "cursor" -or $Editor -eq "both") {
    Get-ChildItem "$Target/.cursor" -Recurse -File | Sort-Object FullName | ForEach-Object {
        Write-Host "  $($_.FullName)"
    }
}

Write-Host ""
Write-Host "Next steps:"
Write-Host "  1. cd $Target"
if ($Editor -eq "claude") {
    Write-Host "  2. Open Claude Code and run /{{INTERVIEW_COMMAND}}"
} elseif ($Editor -eq "cursor") {
    Write-Host "  2. Open Cursor and run /{{INTERVIEW_COMMAND}} in Agent mode"
} else {
    Write-Host "  2. Open Claude Code or Cursor and run /{{INTERVIEW_COMMAND}}"
}
Write-Host "  3. Follow the workflow: /{{BRIEF_COMMAND}} -> /{{PLAN_COMMAND}} -> /decompose -> /start"
Write-Host ""
